# $Id: makefile_rex,v 1.3 1999/06/05 19:02:15 ariadne Exp $
#
# ReactOS Operating System
#
# Makefile for user32.dll
#
include ../../rules.mak

TARGET=user32

ifneq ($(HOST),mingw32-windows)
  ifneq ($(HOST),mingw32-linux)
    DLLTARGET=$(TARGET).a
  else
    DLLTARGET=$(TARGET).dll
  endif
else
  DLLTARGET=$(TARGET).dll
endif

all: $(DLLTARGET)


MISC_OBJECTS = misc/sprintf.o misc/exitwin.o misc/dllmain.o misc/string.o

#RESOURCE_OBJECT = $(TARGET).coff

WINDOWS_OBJECTS = windows/message.o windows/wndproc.o windows/win.o windows/hook.o windows/spy.o\
		windows/queue.o

OBJECTS = $(MISC_OBJECTS)  $(WINDOWS_OBJECTS)

ifeq ($(DOSCLI),yes)
CLEAN_FILES = misc\*.o \
              $(TARGET).o $(TARGET).a junk.tmp base.tmp temp.exp $(TARGET).dll $(TARGET).sym
else
CLEAN_FILES = misc/*.o  \
              $(TARGET).o $(TARGET).a junk.tmp base.tmp temp.exp $(TARGET).dll $(TARGET).sym
endif

$(TARGET).coff: $(TARGET).rc ../../include/reactos/resource.h
	$(RC) $(TARGET).rc $(TARGET).coff

$(TARGET).a: $(OBJECTS)
	$(AR) csr $(TARGET).a $(OBJECTS)

$(TARGET).dll: $(DLLMAIN) $(OBJECTS) $(TARGET).def
	$(LD) -r $(OBJECTS) -o $(TARGET).o
	$(DLLTOOL) \
		--dllname $(TARGET).dll \
		--def $(TARGET).def \
		--output-lib $(TARGET).a \
		--add-stdcall-alias \
		--kill-at
	$(CC) $(TARGET).o \
		../ntdll/ntdll.a \
		../kernel32/kernel32.a \
		-specs=$(TARGET)_specs \
		-mdll \
		-o junk.tmp \
		-Wl,--base-file,base.tmp 
	- $(RM) junk.tmp
	$(DLLTOOL) \
		--dllname $(TARGET).dll \
		--base-file base.tmp \
	        --output-exp temp.exp \
		--def $(TARGET).def \
		--add-stdcall-alias \
		--kill-at
	- $(RM) base.tmp
	$(CC) $(TARGET).o \
		../ntdll/ntdll.a\
		../kernel32/kernel32.a \
		-specs=$(TARGET)_specs \
		-mdll \
		-o $(TARGET).dll \
		-Wl,--image-base,0x70000000 \
		-Wl,--file-alignment,0x1000 \
		-Wl,--section-alignment,0x1000 \
		-Wl,temp.exp
	- $(RM) temp.exp
	$(NM) --numeric-sort $(TARGET).dll > $(TARGET).sym

clean: $(CLEAN_FILES:%=%_clean)

$(CLEAN_FILES:%=%_clean): %_clean:
	- $(RM) $*

.PHONY: clean $(CLEAN_FILES:%=%_clean)

# EOF
